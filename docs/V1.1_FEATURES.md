# Nooa Core Engine v1.1+ - Advanced Features

This document summarizes all advanced features implemented in versions 1.1 and 1.2 of the Nooa Core Engine.

## Version 1.2 Features (Hygiene Rules)

### ✅ 4. Synonym Detection (`find_synonyms`)
**Status**: Fully Implemented
**Documentation**: `docs/HYGIENE_RULES.md`

Detects classes with very similar names using Jaro-Winkler similarity algorithm.

**Syntax**:
```yaml
- name: "Detect-Duplicate-Use-Cases"
  severity: warning
  for:
    role: USE_CASE
  options:
    similarity_threshold: 0.85
    thesaurus:
      - [Creator, Generator, Builder]
  rule: "find_synonyms"
```

**Implementation**:
- Jaro-Winkler distance algorithm for string similarity
- Thesaurus-based normalization
- Configurable similarity threshold
- Automatic suffix removal (usecase, impl, adapter, etc.)

---

### ✅ 5. Unreferenced Code Detection (`detect_unreferenced`)
**Status**: Fully Implemented
**Documentation**: `docs/HYGIENE_RULES.md`

Detects zombie files (not imported by any other file).

**Syntax**:
```yaml
- name: "Detect-Zombie-Files"
  severity: info
  for:
    role: ALL
  options:
    ignore_patterns:
      - "^src/main/server\\.ts$"
      - "/index\\.ts$"
  rule: "detect_unreferenced"
```

**Implementation**:
- Reverse dependency graph analysis
- Configurable ignore patterns
- O(N) complexity

---

## Version 1.1 Features (Architectural Validation)

### ✅ 1. Circular Dependency Detection
**Status**: Fully Implemented
**Documentation**: `docs/CIRCULAR_DEPENDENCY_DETECTION.md`

Detects circular dependencies using Depth-First Search (DFS) algorithm.

**Syntax**:
```yaml
- name: "No-Circular-Dependencies"
  severity: error
  from:
    role: ALL
  to:
    circular: true
  rule: "forbidden"
```

**Implementation**:
- Modified `ArchitecturalRuleModel` to support `to: { circular: true }`
- Added `roleMatches()` support for `'ALL'` meta-role
- Implemented DFS algorithm with WHITE/GRAY/BLACK states
- O(V + E) complexity

---

### ✅ 2. Required Dependencies
**Status**: Fully Implemented
**Documentation**: `docs/REQUIRED_DEPENDENCIES.md`

Ensures that specific architectural connections exist.

**Syntax**:
```yaml
- name: "Use-Case-Must-Implement-Contract"
  severity: error
  from:
    role: USE_CASE_IMPL
  to:
    role: USE_CASE_CONTRACT
  rule: "required"
```

**Implementation**:
- Validates that symbols with `from.role` have at least one dependency matching `to.role`
- Supports multiple target roles with array syntax
- Clear violation messages showing what's missing

---

### ✅ 3. Naming Pattern Validation
**Status**: Fully Implemented

Validates that file paths follow naming conventions.

**Syntax**:
```yaml
- name: "Adapter-Naming-Convention"
  severity: warning
  for:
    role: ADAPTER
  pattern: "\\.(adapter|repository)\\.ts$"
  rule: "naming_pattern"
```

**Implementation**:
- Created discriminated union `ArchitecturalRuleModel = DependencyRule | NamingPatternRule`
- Added `validateNamingPatterns()` method
- Regex pattern validation at parse time
- Type-safe discrimination between rule types

---

### ✅ 4. Advanced Syntax Features
**Status**: Fully Implemented

#### 4.1 `role: ALL` Meta-Role

Matches any role in the codebase.

```yaml
from:
  role: ALL  # Applies to all symbols
```

**Use cases**:
- Global circular dependency detection
- Universal naming conventions
- Cross-cutting concerns

#### 4.2 Multiple Roles with Arrays

Specify multiple acceptable roles.

```yaml
to:
  role: [PROTOCOL, INTERFACE, CONTRACT]
```

**Use cases**:
- Flexible required dependencies
- Alternative valid targets

---

## Type System Enhancements

### Discriminated Unions

The rule model now uses TypeScript discriminated unions for type safety:

```typescript
type DependencyRule = {
  from: RuleFrom;
  to: RuleTo;
  rule: 'allowed' | 'forbidden' | 'required';
  // ...
};

type NamingPatternRule = {
  for: RuleFor;
  pattern: string;
  rule: 'naming_pattern';
  // ...
};

type ArchitecturalRuleModel = DependencyRule | NamingPatternRule;
```

This provides:
- ✅ **Compile-time safety**: TypeScript prevents accessing wrong properties
- ✅ **Runtime validation**: YAML parser validates structure
- ✅ **Type guards**: Proper filtering and narrowing

---

## Architecture Validation Flow

```
1. Load Grammar (YAML)
   ├─> Parse and validate structure
   └─> Transform to typed models

2. Parse Codebase (ts-morph)
   ├─> Extract symbols
   └─> Build dependency graph

3. Assign Roles
   └─> Match paths against role patterns

4. Validate (in order)
   ├─> Circular Dependencies (highest priority)
   ├─> Required Dependencies
   ├─> Naming Patterns
   └─> Forbidden/Allowed Dependencies

5. Report Violations
   └─> Grouped by severity
```

---

## Example Complete Grammar

```yaml
version: 1.1
language: typescript

roles:
  - name: DOMAIN
    path: "^src/domain"
  - name: USE_CASE_IMPL
    path: "^src/data/usecases"
  - name: ADAPTER
    path: "^src/infra"

rules:
  # 1. Detect Cycles (Always First!)
  - name: "No-Circular-Dependencies"
    severity: error
    from:
      role: ALL
    to:
      circular: true
    rule: "forbidden"

  # 2. Require Good Connections
  - name: "Use-Case-Must-Have-Contract"
    severity: error
    from:
      role: USE_CASE_IMPL
    to:
      role: DOMAIN
    rule: "required"

  # 3. Validate Naming
  - name: "Adapters-Must-End-With-Adapter"
    severity: warning
    for:
      role: ADAPTER
    pattern: "\\.adapter\\.ts$"
    rule: "naming_pattern"

  # 4. Prevent Bad Connections
  - name: "Domain-Independence"
    severity: error
    from:
      role: DOMAIN
    to:
      role: [USE_CASE_IMPL, ADAPTER]
    rule: "forbidden"
```

---

## Performance

All features are optimized for large codebases:

- **Circular Detection**: O(V + E) using DFS
- **Required Dependencies**: O(N × M) where N = symbols, M = dependencies per symbol
- **Naming Patterns**: O(N) with compiled regex
- **Forbidden Rules**: O(N × M × R) where R = rules (optimized with early returns)

---

## Backwards Compatibility

✅ All v1.0 grammar files work without modification
✅ New features are opt-in
✅ No breaking changes to existing APIs

---

## Future Enhancements (Not Yet Implemented)

- `path_not`: Negative path patterns
- `allowed` rule enforcement (whitelist mode)
- Cross-file symbol resolution improvements
- Performance optimizations for very large codebases (>10k files)
- Plugin system for custom rules

---

## Testing

To test all features:

```bash
# Self-validation
npm start .

# With test grammar
npm start ./path/to/test-project
```

---

## Summary

Nooa Core Engine v1.1 transforms architectural validation from a simple "forbidden dependency" checker into a comprehensive architectural enforcement tool that:

1. **Prevents bad patterns** (circular dependencies, forbidden dependencies)
2. **Enforces good patterns** (required dependencies)
3. **Validates conventions** (naming patterns)
4. **Provides flexibility** (ALL meta-role, multiple targets)

All while maintaining Clean Architecture principles in its own implementation.
